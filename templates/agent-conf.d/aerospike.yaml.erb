### MANAGED BY PUPPET

# AF: BUGS:
# AF: If some metric does not show up in Datadog:
# AF: while investigating why some metrics were not appearing in Datadog, i saw that the Datadog script uses the `mappings` dict below to see which metrics to send as `rate` and if not in `mappings` then send as `gauge`. But this list of mappings is taken as is from https://github.com/aerospike/aerospike-collectd/blob/develop/aerospike_schema.yaml `operations`. Yet some metrics though being labeled as `operations` should not be considered as `rates` but instead as `gauges` and as such not appear in below dict `mappings`

init_config:
  # Rate mappings. DO NOT EDIT unless you know what you're doing.
  # See https://github.com/aerospike/aerospike-collectd/blob/develop/aerospike_schema.yaml
  # for the definitive list
  mappings:
    - basic_scans_failed    # moved to NS scan_basic_error
    - basic_scans_succeeded    # moved to NS scan_basic_complete
    - batch_error
    - batch_index_initiate
    - batch_index_complete
    - batch_index_timeout
    - batch_index_error
    - batch_index_unused_buffers
    - batch_index_huge_buffers
    - batch_index_created_buffers
    - batch_index_destroyed_buffers
    - batch_initiate
    - batch_timeout
    - demarshal_error
    - dlog_logged
    - dlog_overwritten_error
    - dlog_processed_link_down
    - dlog_processed_main
    - dlog_processed_replica
    - dlog_relogged
    - dlog_used_objects
    - early_tsvc_batch_sub_error
    - early_tsvc_client_error
    - early_tsvc_udf_sub_error
    - err_duplicate_proxy_request
    - err_out_of_space
    - err_recs_dropped            # renamed xdr_queue_overflow_error
    - err_replica_non_null_node
    - err_replica_null_node
    - err_rw_cant_put_unique
    - err_rw_pending_limit     # moved to NS fail_key_busy
    - err_rw_request_not_found
    - err_storage_queue_full
    - err_sync_copy_null_master
    - err_sync_copy_null_node
    - err_tsvc_requests
    - err_tsvc_requests_timeout       # moved to NS tsvc_client_timeout
    - err_write_fail_bin_exists
    - err_write_fail_bin_name
    - err_write_fail_bin_not_found
    - err_write_fail_forbidden      # moved to NS fail_xdr_forbidden
    - err_write_fail_generation     # moved to NS fail_generation
    - err_write_fail_generation_xdr
    - err_write_fail_incompatible_type
    - err_write_fail_key_exists
    - err_write_fail_key_mismatch
    - err_write_fail_not_found
    - err_write_fail_noxdr
    - err_write_fail_parameter
    - err_write_fail_prole_delete
    - err_write_fail_prole_generation
    - err_write_fail_prole_unknown
    - err_write_fail_record_too_big    # moved to NS fail_record_too_big
    - err_write_fail_unknown
    - fabric_msgs_rcvd
    - fabric_msgs_sent
    - heartbeat_received_foreign
    - heartbeat_received_self
    - hotkeys_fetched        # renamed xdr_hotkey_fetch
    - info_complete
    - local_recs_error        # renamed xdr_read_error
    - local_recs_fetch_avg_latency        # renamed xdr_read_latency_avg
    - local_recs_fetched        # renamed xdr_read_success
    - local_recs_notfound        # renamed xdr_read_not_found
    - migrate_msgs_recv
    - migrate_msgs_sent
    - migrate_num_incoming_accepted
    - migrate_num_incoming_refused
    - noship_recs_expired
    - noship_recs_hotkey    # renamed xdr_hotkey_skip
    - noship_recs_notmaster
    - noship_recs_uninitialized_destination        # renamed xdr_uninitialized_destination_error
    - noship_recs_unknown_namespace            # renamed xdr_unknown_namespace_error
    - proxy_action
    - proxy_initiate
    - proxy_retry
    - proxy_retry_new_dest
    - proxy_retry_q_full
    - proxy_retry_same_dest
    - proxy_unproxy
    - query_abort        # moved to NS
    - query_agg        # moved to NS
    - query_agg_abort     # moved to NS
    - query_agg_avg_rec_count    # moved to NS
    - query_agg_err     # moved to NS query_agg_error
    - query_agg_success    # moved to NS
    - query_avg_rec_count     # moved to NS
    - query_fail        # moved to NS
    - query_long_queue_full    # moved to NS
    - query_long_reqs    # moved to NS
    - query_long_running
    - query_lookup_abort    # moved to NS
    - query_lookup_avg_rec_count    # moved to NS
    - query_lookup_err        # moved to NS query_lookup_error
    - query_lookups    # moved to NS
    - query_lookup_success        # moved to NS
    - query_reqs                # moved to NS
    - query_short_queue_full    # moved to NS
    - query_short_reqs        # moved to NS
    - query_short_running
    - query_success        # moved to NS
    - query_tracked
    - read_dup_prole
    - reaped_fds
    - rw_err_ack_badnode
    - rw_err_ack_internal
    - rw_err_ack_nomatch
    - rw_err_dup_cluster_key
    - rw_err_dup_internal
    - rw_err_dup_send
    - rw_err_write_cluster_key
    - rw_err_write_internal
    - rw_err_write_send
    - scans_active
    - sindex_gc_activity_dur
    - sindex_gc_garbage_cleaned
    - sindex_gc_garbage_found
    - sindex_gc_inactivity_dur
    - sindex_gc_list_creation_time
    - sindex_gc_list_deletion_time
    - sindex_gc_locktimedout
    - sindex_gc_objects_validated
    - sindex_ucgarbage_found
    - stat_cluster_key_err_ack_dup_trans_reenqueue
    - stat_cluster_key_err_ack_rw_trans_reenqueue
    - stat_cluster_key_partition_transaction_queue_count
    - stat_cluster_key_prole_retry
    - stat_cluster_key_regular_processed
    - stat_cluster_key_transaction_reenqueue
    - stat_cluster_key_trans_to_proxy_retry
    - stat_deleted_set_objects
    - stat_delete_success        # moved to NS client_delete_success
    - stat_duplicate_operation
    - stat_evicted_objects        # moved to NS evicted_objects
    - stat_expired_objects        # moved to NS expired_objects
    - stat_ldt_proxy
    - stat_nsup_deletes_not_shipped
    - stat_evicted_set_objects
    - stat_proxy_errs        # moved to NS client_proxy_error
    - stat_proxy_reqs
    - stat_proxy_reqs_xdr
    - stat_proxy_success    # moved to NS client_proxy_complete
    - stat_read_errs_notfound    # moved to NS client_read_not_found
    - stat_read_errs_other        # moved to NS client_read_error
    - stat_read_reqs
    - stat_read_reqs_xdr
    - stat_read_success    # moved to NS client_read_success
    - stat_recs_inflight    # renamed xdr_ship_inflight_objects
    - stat_recs_linkdown_processed    # renamed dlog_processed_link_down
    - stat_recs_logged        # renamed dlog_logged
    - stat_recs_logged_master
    - stat_recs_outstanding    # renamed xdr_ship_outstanding_objects
    - stat_recs_relogged        # renamed dlog_relogged
    - stat_recs_relogged_incoming    # renamed xdr_relogged_incoming
    - stat_recs_relogged_outgoing    # renamed xdr_relogged_outgoing
    - stat_recs_replprocessed        # renamed dlog_processed_replica
    - stat_recs_shipped
    - stat_recs_shipped_binlevel
    - stat_recs_shipped_ok        # renamed xdr_ship_success
    - stat_rw_timeout        # moved to NS client_read_timeout, client_write_timeout
    - stat_slow_trans_queue_batch_pop
    - stat_slow_trans_queue_pop
    - stat_slow_trans_queue_push
    - stat_write_errs        # moved to NS client_write_error
    - stat_write_errs_notfound
    - stat_write_errs_other    # moved to NS client_write_error
    - stat_write_reqs
    - stat_write_reqs_xdr    # moved to NS  to xdr_write_success
    - stat_write_success        # moved to NS client_write_success
    - stat_xdr_pipe_miss
    - stat_xdr_pipe_writes
    - stat_zero_bin_records
    - storage_defrag_corrupt_record
    - transactions
    - tscan_aborted
    - tscan_initiate
    - tscan_pending
    - tscan_succeeded
    - udf_bg_scans_succeeded    # moved to NS udf_bg_scan_failure
    - udf_bg_scans_failed        # moved to NS udf_bg_scan_success
    - udf_delete_err_others
    - udf_delete_reqs
    - udf_delete_success    # moved to NS client_lang_delete_success
    - udf_lua_errs        # moved to NS client_lang_error, udf_sub_udf_error
    - udf_query_rec_reqs
    - udf_read_errs_other
    - udf_read_reqs
    - udf_read_success        # moved to NS client_lang_read_success
    - udf_replica_writes
    - udf_scan_rec_reqs
    - udf_write_err_others
    - udf_write_reqs
    - udf_write_success    # moved to NS client_lang_write_success
    - write_master
    - write_prole
    - xdr_deletes_canceled
    - xdr_deletes_shipped    # renamed xdr_ship_delete_success
    - xdr_hotkey_fetch
    - xdr_hotkey_skip
    - xdr_queue_overflow_error
    - xdr_read_error
    - xdr_read_not_found
    - xdr_read_reqq_used
    - xdr_read_respq_used
    - xdr_read_success
    - xdr_relogged_incoming
    - xdr_relogged_outgoing
    - xdr_ship_bytes
    - xdr_ship_delete_success
    - xdr_ship_destination_error
    - xdr_ship_inflight_objects
    - xdr_ship_fullrecord
    - xdr_ship_outstanding_objects
    - xdr_ship_source_error
    - xdr_ship_success
    - xdr_uninitialized_destination_error
    - xdr_unknown_namespace_error
    - xdr_uptime

    # ==============================================================================
    # Namespace specific metrics recorded per namespace
    # ------------------------------------------------------------------------------

    # inline comments indicate moved/renamed metrics starting with ASD 3.9+
    - appeals_records_exonerated
    - batch_sub_proxy_complete
    - batch_sub_proxy_error
    - batch_sub_proxy_timeout
    - batch_sub_read_error
    - batch_sub_read_not_found
    - batch_sub_read_success
    - batch_sub_read_timeout
    - batch_sub_tsvc_error
    - batch_sub_tsvc_timeout
    - client_delete_error
    - client_delete_not_found
    - client_delete_success
    - client_delete_timeout
    - client_lang_delete_success
    - client_lang_error
    - client_lang_read_success
    - client_lang_write_success
    - client_proxy_complete
    - client_proxy_error
    - client_proxy_timeout
    - client_read_error
    - client_read_not_found
    - client_read_success
    - client_read_timeout
    - client_tsvc_error
    - client_tsvc_timeout
    - client_udf_complete
    - client_udf_error
    - client_udf_timeout
    - client_write_error
    - client_write_success
    - client_write_timeout
    - evicted-objects
    - evicted_objects
    - evict_ttl
    - expired-objects
    - expired_objects
    - fail_generation
    - fail_key_busy
    - fail_record_too_big
    - fail_xdr_forbidden
    - geo_region_query_cells
    - geo_region_query_falsepos
    - geo_region_query_points
    - geo_region_query_reqs
    - ldt_deletes
    - ldt_delete_success
    - ldt_errors
    - ldt_reads
    - ldt_read_success
    - ldt_updates
    - ldt_writes
    - ldt_write_success
    - migrate-record-receives
    - migrate_record_receives
    - migrate-record-retransmits
    - migrate_record_retransmits
    - migrate-records-skipped
    - migrate_records_skipped
    - migrate-records-transmitted
    - migrate_records_transmitted
    - query_abort
    - query_agg
    - query_agg_abort
    - query_agg_avg_rec_count
    - query_agg_error
    - query_agg_success
    - query_avg_rec_count
    - query_fail
    - query_long_queue_full
    - query_long_reqs
    - query_lookup_abort
    - query_lookup_avg_rec_count
    - query_lookup_err
    - query_lookup_success
    - query_lookups
    - query_reqs
    - query_short_queue_full
    - query_short_reqs
    - query_success
    - query_udf_bg_failure
    - query_udf_bg_success
    - scan_aggr_abort
    - re_repl_error
    - re_repl_success
    - re_repl_timeout
    - scan_aggr_complete
    - scan_aggr_error
    - scan_basic_abort
    - scan_basic_complete
    - scan_basic_error
    - scan_udf_bg_abort
    - scan_udf_bg_complete
    - scan_udf_bg_error
    - set-deleted-objects
    - set_deleted_objects
    - set-evicted-objects
    - udf_sub_lang_delete_success
    - udf_sub_lang_error
    - udf_sub_lang_read_success
    - udf_sub_lang_write_success
    - udf_sub_udf_complete
    - udf_sub_udf_error
    - udf_sub_udf_timeout
    - udf_sub_tsvc_error
    - udf_sub_tsvc_timeout
    - xdr_read_success
    - xdr_write_error
    - xdr_write_success
    - xdr_write_timeout

    # ==============================================================================
    # Datacenter (XDR) specific metrics recorded per datacenter
    # ------------------------------------------------------------------------------

    # inline comments indicate moved/renamed metrics starting with ASD 3.9+
    - dc_remote_ship_ok
    - dc_rec_ship_attempts        # renamed dc_ship_attempt
    - dc_delete_ship_attempts    # renamed dc_ship_delete_success
    - dc_ship_attempt
    - dc_ship_delete_success
    - dc_ship_destination_error
    - dc_ship_source_error
    - dc_ship_success


instances:
<%- (Array(@_instances)).each do |instance| -%>
  - host: <%= instance['host'] %>
    <%- if instance['port'] && instance['port'] != :undef -%>
    port: <%= instance['port'] %>
    <%- end -%>

    # All metrics collected by default. You probably don't want to do this,
    # so list the ones you do want here. Check with asinfo -v statistics -l
    # and asinfo -v namespace/YOURNAMESPACE -l.

    metrics:
      <%- if instance['metrics'] and ! instance['metrics'].empty? -%>
      <%- instance['metrics'].each do |metric| -%>
      - <%= metric %>
      <%- end -%>
      <%- else -%>
      - cluster_size
      - uptime
      - batch_queue  # Number of batch direct requests remaining on the queue awaiting processing.
      - xdr_timelag  # IF xdr_timelag consistently greater than a few seconds THEN may indicate network connectivity issues or errors writing at a destination cluster. The knowledge base article on XDR throttling may be helpful.
      - client_connections  # Number of active client connections to this node
      - fabric_connections  # Number of active fabric connections to this node
      - failed_node_sessions_pending
      - info_queue  # Number of info requests pending in info queue
      - migrate_partitions_remaining  # Number of partitions remaining to migrate in either direction
      - objects  # Total number of replicated objects on this node. Includes master and replica objects.
      - rw_in_progress  # Number of rw transactions in progress
      - proxy_in_progress  # Number of proxies in progress
      - tombstones  # Total number tombstones in this namespace on this node
      - transaction_queue_used
      - tsvc_queue  # Number of pending requests waiting to execute in the transaction queue
      - query_long_queue_size
      - query_short_queue_size
      - xdr_ship_latency_avg  # Moving average latency to ship a record to remote Aerospike clusters. shown as millisecond
      - cluster_integrity  # Indicates whether the cluster is in a whole and complete state (as far as the nodes that it sees and is able to connect to are all concerned.)
      - cluster_is_member
      - system_swapping  # Indicate that the system is currently swapping RAM to disk
      - dlog_free_pct  # Percentage of the digest log free and available for use. shown as percent
      - heap_efficiency_pct  # This represents the heap_allocated_kbytes / heap_mapped_kbytes ratio. A lower number indicates a higher fragmentation rate. shown as percent
      - transaction_queue_used_pct  # shown as percent
      - heap_allocated_kbytes  # The amount of memory allocated by the asd daemon. shown as kibibyte
      - heap_active_kbytes  # The amount of memory in in-use pages. An in-use page is a page that has some allocated memory (either partial or full). shown as kibibyte
      - batch_error  # Number of batch direct requests that were rejected because of errors.
      - batch_initiate  # Number of batch direct requests received
      - batch_timeout  # Number of batch direct requests that timed-out on the server before being processed
      - dlog_processed_main  # Number of records processed on the local Aerospike server.
      - dlog_processed_replica  # Number of records processed for a node in the cluster that is not the local node
      - scans_active  # scans_active
      <%- end -%>

    namespace_metrics:
      <%- if instance['namespace_metrics'] and ! instance['namespace_metrics'].empty? -%>
      <%- instance['namespace_metrics'].each do |namespace_metric| -%>
      - <%= namespace_metric %>
      <%- end -%>
      <%- else -%>
      - evicted_objects  # Number of objects evicted from this namespace on this node since the server started
      - expired_objects  # Number of objects expired from this namespace on this node since the server started.
      - device_available_pct  # IF device_available_pct drops below 20% THEN may indicate that defrag is unable to keep up with the current load, warn operations. IF device_available_pct drops below 15% THEN critical alert to operations, usable disk resources are critically low may result in a stop-writes if situation if device_available_pct drops below 5%.
      - clock_skew_stop_writes  # IF clock_skew_stop_writes is true THEN critical alert to operations. Ensure clocks are in sync across the cluster.
      - available_bin_names  # Remaining number of unique bins that the user can create for this namespace.
      - master-objects  # Number of records on this node which are active masters
      - migrate_tx_partitions_imbalance  # Number of partition migrations failures which could lead to partitions being imbalanced
      - non_expirable_objects  # Number of records in this namespace with non-expirable TTLs (TTLs of value 0).
      - objects  # Number of records in this namespace for this node. Does not include tombstones.
      - prole_objects  # Number of records on this node which are proles (replicas) on this node. Does not include tombstones
      - non_replica_objects  # Number of records on this node which are neither master nor replicas. This number is non-zero only during migration, representing additional versions or copies of records. Those are records beyond the replication factor line and would be potentially used during migrations to duplicate resolve.
      - effective_replication_factor  # The effective replication factor for the namespace
      - tombstones  # Total number tombstones in this namespace on this node
      - device_total_bytes  # Total bytes of disk space allocated to this namespace on this node. shown as bytes
      - memory_used_bytes  # Total bytes of memory used by this namespace on this node
      - hwm_breached  # If true Aerospike has breached 'high-water-[disk|memory]-pct' for this namespace.
      - stop_writes  # If true this namespace is currently not allowing writes.
      - cache_read_pct  # Percentage of read transactions that are hitting the post write queue and will save an io to the underlying storage device.
      - client_delete_error  # Number of client delete transactions that failed with an error.
      - client_lang_error  # Number of client initiated udf transactions that failed with an error
      - client_udf_error  # Number of failed udf transactions initiated by the client
      - client_read_error
      - client_read_not_found
      - client_read_timeout
      - client_write_error
      - client_write_timeout
      - query_long_queue_full  # Number of long running queries queue full errors.
      - query_long_reqs  # Number of long running queries currently in process
      - query_short_queue_full  # Number of short running queries queue full errors.
      - query_short_reqs  # Number of short running queries currently in process
      - query_udf_bg_failure  # Number of udf background queries that failed on this node
      - scan_aggr_abort  # Number of scan aggregations that were aborted.
      - scan_aggr_error  # Number of scan aggregations that were aborted.
      - dead_partitions  # IF dead_partitions non 0 THEN critical alert to operations. Consider issuing revive and recluster commands if potential inconsistencies are known to not exist or acceptable to have.
      - unavailable_partitions  # IF unavailable_partitions non 0 THEN critical alert to operations. Check for network issues and make sure cluster forms properly.
      <%- end -%>
<%- end -%>

<% if @tags and ! @tags.empty? -%>
  - tags:
  <%- @tags.each do |tag| -%>
    - <%= tag %>
  <%- end -%>
<% end -%>
